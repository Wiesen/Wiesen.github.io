<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>çŠ¶æ€æœº&amp;äº‹ä»¶é©±åŠ¨&amp;eventloop</title>
        <style>

    html body {
        font-family: Raleway, sans-serif;
        background-color: white;
    }

    :root {
        --accent: red;
        --border-width:  5px ;
    }

</style>


<link rel="stylesheet" href="/css/main.css">





<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">


 <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-dark.min.css"> 


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
 


    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

     <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/java.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/python.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/c.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/c&#43;&#43;.min.js"></script> 

    <script>hljs.initHighlightingOnLoad();</script>







<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<script>$(document).on('click', function() { $('.collapse').collapse('hide'); })</script>
 <meta name="generator" content="Hugo 0.29" />
        
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-73790691-1"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments)};
          gtag('js', new Date());

          gtag('config', 'UA-73790691-1');
        </script>
    </head>

    <body>

        <nav class="navbar navbar-default navbar-fixed-top">

            <div class="container">

                <div class="navbar-header">

                    <a class="navbar-brand visible-xs" href="#">çŠ¶æ€æœº&amp;äº‹ä»¶é©±åŠ¨&amp;eventloop</a>

                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>

                </div>

                <div class="collapse navbar-collapse">

                    
                        <ul class="nav navbar-nav">
                            
                                <li><a href="/">Home</a></li>
                            
                                <li><a href="/post/">Posts</a></li>
                            
                                <li><a href="/project/">Projects</a></li>
                            
                        </ul>
                    

                    
                        <ul class="nav navbar-nav navbar-right">
                            
                                <li class="navbar-icon"><a href="mailto:yangwj92@gmail.com"><i class="fa fa-envelope-o"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://github.com/Wiesen/"><i class="fa fa-github"></i></a></li>
                            
                        </ul>
                    

                </div>

            </div>

        </nav>


<main>

    <div class="item">

    
    
    

    
    

    <h4><a href="/post/%E7%8A%B6%E6%80%81%E6%9C%BA%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8eventloop/">çŠ¶æ€æœº&amp;äº‹ä»¶é©±åŠ¨&amp;eventloop</a></h4>
    <h5>February 18, 2018</h5>
     <kbd class="item-tag">network</kbd>  <kbd class="item-tag">Design Pattern</kbd> 

</div>


    <br> <div class="text-justify">

<p>[TOC]</p>

<h1 id="çŠ¶æ€æœºç¼–ç¨‹æ€æƒ³-è‡´äºº-è€Œä¸è‡´äºäºº">çŠ¶æ€æœºç¼–ç¨‹æ€æƒ³ï¼šâ€œè‡´äºº è€Œä¸è‡´äºäººâ€</h1>

<h2 id="1-æœ‰é™çŠ¶æ€æœº">1. æœ‰é™çŠ¶æ€æœº</h2>

<p>Difination: æœ‰é™çŠ¶æ€æœºï¼ˆfinite-state machineï¼‰åˆç§°æœ‰é™çŠ¶æ€è‡ªåŠ¨æœºï¼Œç®€ç§°çŠ¶æ€æœºï¼Œæ˜¯è¡¨ç¤ºæœ‰é™ä¸ªçŠ¶æ€ä»¥åŠåœ¨è¿™äº›çŠ¶æ€ä¹‹é—´çš„è½¬ç§»å’ŒåŠ¨ä½œç­‰è¡Œä¸ºçš„æ•°å­¦æ¨¡å‹ã€‚</p>

<p>Application:</p>

<ol>
<li>è‡ªç„¶è¯­è¨€å¤„ç†ï¼šokenizerã€parserã€regexp</li>
<li>ç½‘ç»œåè®®</li>
<li>æ¸¸æˆè®¾è®¡</li>
<li>è‡ªåŠ¨å®¢æœ</li>
</ol>

<h2 id="2-äº‹ä»¶é©±åŠ¨ä¸çŠ¶æ€æ¨¡å¼">2. äº‹ä»¶é©±åŠ¨ä¸çŠ¶æ€æ¨¡å¼</h2>

<p>çŠ¶æ€æ¨¡å¼ï¼š</p>

<ol>
<li>motivationï¼š ä¸€ä¸ªä¸šåŠ¡å¦‚æœåŒ…å«å¤šä¸ªé˜¶æ®µï¼Œè€Œå„ä¸ªé˜¶æ®µä¹‹é—´åˆå¹¶éé¡ºåºæ‰§è¡Œï¼Œå¯èƒ½å­˜åœ¨å¤æ‚çš„æ¡ä»¶è·³è½¬ã€‚æ­¤æ—¶ï¼Œè¿ç”¨çŠ¶æ€æ¨¡å¼å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç†æ¸…ä¸šåŠ¡é€»è¾‘ï¼Œå¹¶å‘ç°ä¸€äº›é€»è¾‘ç¼ºé™·ã€‚</li>
<li>å®šä¹‰ï¼šçŠ¶æ€æ¨¡å¼ï¼ˆState Patternï¼‰ä¸­ï¼Œç±»çš„è¡Œä¸ºæ˜¯åŸºäºå®ƒçš„çŠ¶æ€æ”¹å˜çš„ã€‚è¿™ç§ç±»å‹çš„è®¾è®¡æ¨¡å¼å±äºè¡Œä¸ºå‹æ¨¡å¼ã€‚</li>
<li>æ„å›¾ï¼šå…è®¸å¯¹è±¡åœ¨å†…éƒ¨çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶æ”¹å˜å®ƒçš„è¡Œä¸ºï¼Œå¯¹è±¡çœ‹èµ·æ¥å¥½åƒä¿®æ”¹äº†å®ƒçš„ç±»ã€‚</li>
<li>ä¸»è¦è§£å†³ï¼šå¯¹è±¡çš„è¡Œä¸ºä¾èµ–äºå®ƒçš„çŠ¶æ€ï¼ˆå±æ€§ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥æ ¹æ®å®ƒçš„çŠ¶æ€æ”¹å˜è€Œæ”¹å˜å®ƒçš„ç›¸å…³è¡Œä¸ºã€‚</li>
<li>ä½•æ—¶ä½¿ç”¨ï¼šä»£ç ä¸­åŒ…å«å¤§é‡ä¸å¯¹è±¡çŠ¶æ€æœ‰å…³çš„æ¡ä»¶è¯­å¥ã€‚</li>
<li>å¦‚ä½•è§£å†³ï¼šå°†å„ç§å…·ä½“çš„çŠ¶æ€ç±»æŠ½è±¡å‡ºæ¥ã€‚</li>
</ol>

<p>çŠ¶æ€æ¨¡å¼åŒ…å«ä¸‰ä¸ªè§’è‰²ï¼š</p>

<ol>
<li>Contextï¼šç¯å¢ƒç±»åˆç§°ä¸ºä¸Šä¸‹æ–‡ç±»ï¼Œå®ƒæ˜¯æ‹¥æœ‰çŠ¶æ€çš„å¯¹è±¡ï¼Œåœ¨ç¯å¢ƒç±»ä¸­ç»´æŠ¤ä¸€ä¸ªæŠ½è±¡çŠ¶æ€ç±»Stateçš„å®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹å®šä¹‰å½“å‰çŠ¶æ€ï¼Œåœ¨å…·ä½“å®ç°æ—¶ï¼Œå®ƒæ˜¯ä¸€ä¸ªStateå­ç±»çš„å¯¹è±¡ï¼Œå¯ä»¥å®šä¹‰åˆå§‹çŠ¶æ€ï¼›</li>
<li>Stateï¼šæŠ½è±¡çŠ¶æ€ç±»ï¼Œç”¨äºå®šä¹‰ä¸€ä¸ªæ¥å£ä»¥å°è£…ä¸ç¯å¢ƒç±»çš„ä¸€ä¸ªç‰¹å®šçŠ¶æ€ç›¸å…³çš„è¡Œä¸ºï¼›</li>
<li>ConcreteStateï¼šå…·ä½“çŠ¶æ€ç±»æ˜¯æŠ½è±¡çŠ¶æ€ç±»çš„å­ç±»ï¼Œæ¯ä¸€ä¸ªå­ç±»å®ç°ä¸€ä¸ªä¸ç¯å¢ƒç±»çš„ä¸€ä¸ªçŠ¶æ€ç›¸å…³çš„è¡Œä¸ºï¼Œæ¯ä¸€ä¸ªå…·ä½“çŠ¶æ€ç±»å¯¹åº”ç¯å¢ƒçš„ä¸€ä¸ªå…·ä½“çŠ¶æ€ï¼Œä¸åŒçš„å…·ä½“çŠ¶æ€ç±»å…¶è¡Œä¸ºæœ‰æ‰€ä¸åŒã€‚</li>
</ol>

<p><img src="/assets/state_pattern_uml_diagram2.jpg" alt="state-pattern-uml-diagram" /></p>

<p><a href="http://chng.github.io/blog/2016/05/13/äº‹ä»¶é©±åŠ¨ä¸‹çš„çŠ¶æ€æ¨¡å¼/">äº‹ä»¶é©±åŠ¨ä¸‹çš„çŠ¶æ€æ¨¡å¼</a>:</p>

<ol>
<li>åŸºäºäº‹ä»¶é©±åŠ¨çš„æ¨¡å‹ï¼Œå¯ä»¥ä½¿å¾—ç³»ç»ŸæŒ‰ç…§é¢„å…ˆå®šä¹‰çš„æ–¹å¼ï¼Œåœ¨çŠ¶æ€æœºä¸­æ‰­è½¬ï¼ˆè¿›å…¥æŸä¸ªçŠ¶æ€æ—¶ï¼Œè§¦å‘ä»€ä¹ˆäº‹ä»¶ï¼‰ã€‚</li>
<li>ä¸€ä¸ªå®Œæ•´çš„ä¸šåŠ¡å¤„ç†è¿‡ç¨‹åŒ…å«å¤šä¸ªçŠ¶æ€è¿ç§»ã€‚è¿™å°±éœ€è¦ä¸€ä¸ªé©±åŠ¨å™¨æ¥ç®¡ç†æ¯ä¸€æ¬¡çš„çŠ¶æ€è¿ç§»ã€‚</li>
<li>ç”±äºçŠ¶æ€çš„è¿ç§»æ˜¯äº‹ä»¶é©±åŠ¨çš„ï¼Œäºæ˜¯å¾ˆå®¹æ˜“æƒ³åˆ°è¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼æ¥è®¾è®¡è¿™æ ·ä¸€ä¸ªé©±åŠ¨å™¨ã€‚äºæ˜¯ï¼ŒçŠ¶æ€æ˜¯Observableï¼Œç”±è®¸å¤šä¸ªObserverè®¢é˜…ï¼Œè€Œæ¯ä¸ªObserverçš„ä»»åŠ¡æ˜¯ï¼Œå½“çŠ¶æ€æœºå› ä¸ºæŸä¸ªäº‹ä»¶è€Œè·³è½¬åˆ°æŸä¸ªçŠ¶æ€æ—¶ï¼Œå‘çŠ¶æ€æœºå‘é€ä¸‹ä¸€ä¸ªäº‹ä»¶çš„é€šçŸ¥ï¼Œç›´åˆ°çŠ¶æ€æœºåˆ°è¾¾ä¸€ä¸ªç»ˆæ­¢çŠ¶æ€ï¼ˆåœ¨è¿™ä¸€æ¨¡å‹ä¸­ï¼Œç»ˆæ­¢çŠ¶æ€å°±æ˜¯æ²¡æœ‰ä»»ä½•Observerè®¢é˜…çš„çŠ¶æ€ï¼‰ã€‚</li>
</ol>

<h1 id="eventloop">eventloop</h1>

<p>difination:</p>

<ol>
<li>the event loop, message dispatcher, message loop, message pump, or run loop is a programming construct that waits for and dispatches events or messages in a program.</li>
<li>It works by making a request to some internal or external &ldquo;event provider&rdquo; (that generally blocks the request until an event has arrived), and then it calls the relevant event handler (&ldquo;dispatches the event&rdquo;).</li>
<li>The event-loop may be used in conjunction with a reactor, if the event provider follows the file interface, which can be selected or &lsquo;polled&rsquo; (the Unix system call, not actual polling).</li>
<li>The event loop almost always operates asynchronously with the message originator.</li>
</ol>

<p>Handling signals:</p>

<ol>
<li>One of the few things in Unix that does not conform to the file interface are asynchronous events (signals). Signals are received in signal handlers, small, limited pieces of code that run while the rest of the task is <strong>suspended</strong>.</li>
<li>To avoid heavy handler, ann obvious way to handle signals is for signal handlers to set a global flag and have the event loop check for the flag immediately before and after the select() call; if it is set, handle the signal in the same manner as with events on file descriptors: gives rise to a race condition.</li>
<li>The solution arrived at by POSIX is the pselect() call, which is similar to select() but takes an additional sigmask parameter, which describes a signal mask. This allows an application to mask signals in the main task, then remove the mask for the duration of the select() call such that signal handlers are only called while the application is I/O bound: implementations of pselect() have only recently become reliable</li>
<li>An alternative, more portable solution, is to convert asynchronous events to file-based events using the self-pipe trick, where &ldquo;a signal handler writes a byte to a pipe whose other end is monitored by select() in the main program&rdquo;. In Linux kernel version 2.6.22, a new system call signalfd() was added, which allows receiving signals via a special file descriptor.</li>
</ol>

<p><a href="https://www.zhihu.com/question/21040222/answer/96976318">everything is a file (descriptor), but</a>:</p>

<ol>
<li>åœ¨ Linux å¼•å…¥ signalfd ä¹‹å‰ï¼Œsignal ä¸æ˜¯æ–‡ä»¶ï¼Œä½ æ²¡åŠæ³•ç”¨ poll æ¥ç­‰å¾… signalï¼Œåªèƒ½ç”¨å±é™©çš„ signal handlerã€‚</li>
<li>åœ¨ FreeBSD å¼•å…¥ pdfork ä¹‹å‰ï¼Œå­è¿›ç¨‹ä¸æ˜¯æ–‡ä»¶ï¼Œä½ æ²¡åŠæ³•ç”¨ poll æ¥ç­‰å¾…å­è¿›ç¨‹é€€å‡ºï¼Œåªèƒ½ waitã€‚ä¹Ÿæ²¡æœ‰åŠæ³•å®‰å…¨ï¼ˆrace-freeï¼‰åœ° kill è¿›ç¨‹ã€‚Linux ä¸æ”¯æŒ pdforkã€‚</li>
<li>ç›´åˆ°ç°åœ¨ï¼Œçº¿ç¨‹ä¹Ÿä¸æ˜¯æ–‡ä»¶ï¼Œä½ æ²¡åŠæ³•ç”¨ poll æ¥ç­‰å¾…çº¿ç¨‹é€€å‡ºï¼Œåªèƒ½ joinã€‚Linux çš„ clone_fd ä¼¼ä¹èƒ½ä»¥æ–‡ä»¶çš„æ–¹å¼ç®¡ç†å­è¿›ç¨‹å’Œçº¿ç¨‹ï¼Œä½†è¿˜æ²¡æœ‰è¿›å…¥ main streamã€‚</li>
<li>Poll ä¹Ÿä¸èƒ½ç”¨äºç£ç›˜IOï¼ŒLinux ä¸æ”¯æŒéé˜»å¡çš„ file IO, å°±ç®—è¿™ä¸ªæ–‡ä»¶ä½äº NFS ä¸Šï¼Œä¹Ÿåªèƒ½é˜»å¡åœ°è¯»ã€‚</li>
<li>ç®—èµ·æ¥ï¼Œåªæœ‰ Sockets æ‰æ˜¯çœŸçš„å¯ poll çš„ â€œå¥½æ–‡ä»¶â€å•Šã€‚å…¶å® select æœ¬èº«ä¹Ÿæ˜¯è·Ÿ Sockets API åŒæ—¶å‘æ˜çš„ã€‚</li>
</ol>

<h1 id="asyncore-deprecated-since-version-3-6-develop-asyncio-instead">asyncore (Deprecated since version 3.6, develop asyncio instead)</h1>

<p>introduction: provides the basic infrastructure for writing asynchronous socket service clients and servers.</p>

<p><a href="https://parijatmishra.wordpress.com/2008/01/04/writing-a-server-with-pythons-asyncore-module/">overview: The basic idea behind the asyncore module is eventloop</a></p>

<ol>
<li>there is a function, asyncore.loop() that does select() on a bunch of â€˜channelsâ€™. Channels are thin wrappers around sockets, and is maintained in a global map.</li>
<li>when select returns, it reports which sockets have data waiting to be read, which ones are now free to send more data, and which ones have errors; loop() examines the event and the socketâ€™s state to create a higher level event;</li>
<li>it then calls a method on the channel corresponding to the higher level event.</li>
</ol>

<pre><code>+-------------+           +--------+
| driver code |---------&gt; | loop() |
+-------------+           +--------+
      |                      |
      |                      | loop-dispatcher API (a)
      |                      |
      |                  +--------------+
      |                  | dispatcher   |
      +-----------------&gt;| subclass     |
                         +--------------+
                             |
                             | dispatcher-logic API (b)
                             |
                         +--------------+
                         | server logic |
                         +--------------+
</code></pre>

<p>The asyncore moduleâ€™s API consists of:</p>

<ol>
<li>the loop() method, to be called by a driver program written by you;</li>
<li>the dispatcher class, to be subclassed by you to do useful stuff. The dispatcher class is what is called â€˜channelâ€™ elsewhere</li>
</ol>

<p>The loop-dispatcher API: <code>loop( [timeout[, use_poll[, map[,count]]]])</code></p>

<ol>
<li>When we create a new dispatcher object, it automatically gets added to a
global list of sockets.</li>
<li>We can over-ride the list that loop looks at, by providing an explicit map:

<ol>
<li>we would need to add/remove dispatchers we create to/from this map ourselves</li>
<li>we will be able to launch multiple threads, each calling loop on different maps (thread safe)</li>
</ol></li>
</ol>

<p>Methods a dispatcher subclass should implement:</p>

<ol>
<li><code>readable()</code>: should return True, if you want the fd to be observed for read events;</li>
<li><code>writable()</code>: should return True, if you want the fd to be observed for write events;</li>
<li><code>handle_read</code>: socket is readable; dispatcher.recv() can be used to actually get the data</li>
<li><code>handle_write</code>: socket is writable; dispatcher.send(data) can be used to actually send the data</li>
<li><code>handle_error</code>: socket encountered an error</li>
<li><code>handle_expt</code>: socket received OOB data (not really used in practice)</li>
<li><code>handle_close</code>: socket was closed remotely or locally</li>
<li>(For server) <code>handle_accept:</code> a new incoming connection can be accept()ed. Call the accept() method really accept the connection. To create a server socket, call the bind() and listen() methods on it first.</li>
<li>(For client) <code>handle_connect</code>: connection to remote endpoint has been made. To initiate the connection, first call the connect() method on it.</li>
</ol>

<p>ä½¿ç”¨ç»éªŒï¼š</p>

<ol>
<li>client é“¾æ¥å»ºç«‹é—®é¢˜ï¼š<code>handle_connect()</code> åœ¨ç¬¬ä¸€æ¬¡è¯»æˆ–å†™äº‹ä»¶åˆ°æ¥æ—¶è¢«è°ƒç”¨ï¼Œè€Œéå»ºç«‹é“¾æ¥æˆåŠŸé©¬ä¸Šè°ƒç”¨</li>
<li>é‡è¿é—®é¢˜ï¼šæˆ‘åœ¨ä½¿ç”¨asyncoreæ—¶éœ€è¦å®ç°é“¾æ¥é‡è¿ï¼Œåˆ†ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š

<ol>
<li>é“¾æ¥æœªæˆåŠŸå»ºç«‹ || server socket close || client socket close unexpectlyï¼šåœ¨ <code>handle_close</code> ä¸­ <code>close</code> socketï¼Œå† <code>create_socket</code> å¹¶è¿›è¡Œ <code>connect</code>ï¼ˆé»˜è®¤å³ä¸ºéé˜»å¡ï¼‰</li>
<li>åº”ç”¨å±‚å¿ƒè·³å¤±è´¥ä»¤ä¸»åŠ¨é‡è¿ï¼šæ¥æ”¶åˆ°åº”ç”¨å±‚å‘é€çš„é‡è¿äº‹ä»¶åï¼Œè°ƒç”¨ä¸Šè¿°å®ç°çš„ <code>handle_close</code> è¿›è¡Œå¤ç”¨å³å¯ã€‚</li>
</ol></li>
<li>ç«¯å£å¤ç”¨é—®é¢˜ï¼š<code>set_resue_addr</code> tell the OS to set the SO_REUSEADDR flag on the server socket</li>
</ol>

<h1 id="éé˜»å¡-socket-åŸºæœ¬åŸç†">éé˜»å¡ socket åŸºæœ¬åŸç†</h1>

<h2 id="1-éé˜»å¡connect-http-dongxicheng-org-network-non-block-connect-implemention">1. <a href="http://dongxicheng.org/network/non-block-connect-implemention/">éé˜»å¡connect</a></h2>

<p>background:</p>

<ol>
<li>TCPè¿æ¥çš„å»ºç«‹æ¶‰åŠåˆ°ä¸€ä¸ªä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹ï¼Œä¸”SOCKETä¸­connectå‡½æ•°éœ€è¦ä¸€ç›´ç­‰åˆ°å®¢æˆ·æ¥æ”¶åˆ°å¯¹äºè‡ªå·±çš„SYNçš„ACKä¸ºæ­¢æ‰è¿”å›</li>
<li>è¿™æ„å‘³ç€æ¯ä¸ªconnectå‡½æ•°æ€»ä¼šé˜»å¡å…¶è°ƒç”¨è¿›ç¨‹è‡³å°‘ä¸€ä¸ªåˆ°æœåŠ¡å™¨çš„RTTæ—¶é—´ï¼Œè€ŒRTTæ³¢åŠ¨èŒƒå›´å¾ˆå¤§ï¼Œä»å±€åŸŸç½‘çš„å‡ ä¸ªæ¯«ç§’åˆ°å‡ ç™¾ä¸ªæ¯«ç§’ç”šè‡³å¹¿åŸŸç½‘ä¸Šçš„å‡ ç§’</li>
<li>è¿™æ®µæ—¶é—´å†…ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œå…¶ä»–å¤„ç†å·¥ä½œï¼Œä»¥ä¾¿åšåˆ°å¹¶è¡Œã€‚åœ¨æ­¤ï¼Œéœ€è¦ç”¨åˆ°éé˜»å¡connect</li>
</ol>

<p>fcntlå‡½æ•°ï¼š</p>

<ol>
<li>fcntlå‡½æ•°å¯æ‰§è¡Œå„ç§æè¿°ç¬¦çš„æ§åˆ¶æ“ä½œï¼Œå¯¹äºsocketæè¿°ç¬¦ï¼Œå¸¸ç”¨åº”ç”¨æ˜¯å°†å…¶è®¾ç½®ä¸ºé˜»å¡å¼IO</li>
<li>socket ä¸€æ—¦è®¾ç½®äº† timeout, å°±è¿›å…¥äº† non-blocking å·¥ä½œæ¨¡å¼ï¼ŒåŸæ¥çš„ send() å’Œ recv() ç­‰çš„ç”¨æ³•å°±å®Œå…¨ä¸åŒäº†ï¼Œå¯èƒ½ä¼šåªå‘é€æˆ–è€…æ¥æ”¶äº†éƒ¨åˆ†æ•°æ®ï¼Œéœ€è¦æ£€æŸ¥è¿”å›å€¼å¹¶å¤šæ¬¡é‡è¯•</li>
<li>makefile() æ˜¯å®Œå…¨ä¸å…è®¸ä½¿ç”¨çš„ï¼Œå®ƒå·²ç»åœ¨ socket æ¨¡å—çš„æ–‡æ¡£ä¸­æ˜ç¡®å£°æ˜</li>
</ol>

<pre><code class="language-c++">int flags;
if((flags = fcntl(fd, F_GETFL)) &lt; 0) //è·å–å½“å‰çš„flagsæ ‡å¿—
    err_sys(â€œF_GETFL error!â€); 
flags |= O_NONBLOCK; //ä¿®æ”¹éé˜»å¡æ ‡å¿—ä½
if(fcntl(fd, F_SETFL, flags) &lt; 0) 
    err_sys(â€œF_SETFL error!â€);
</code></pre>

<p>connectå‡½æ•°ï¼šå¯¹äºéé˜»å¡å¼å¥—æ¥å­—ï¼Œå¦‚æœè°ƒç”¨connectå‡½æ•°ä¼šä¹‹é—´è¿”å›-1ï¼ˆè¡¨ç¤ºå‡ºé”™ï¼‰ï¼Œä¸”é”™è¯¯ä¸ºEINPROGRESSï¼Œè¡¨ç¤ºè¿æ¥å»ºç«‹å¯åŠ¨ä½†æ˜¯å°šæœªå®Œæˆï¼›å¦‚æœè¿”å›0ï¼Œåˆ™è¡¨ç¤ºè¿æ¥å·²ç»å»ºç«‹ï¼Œè¿™é€šå¸¸æ˜¯åœ¨æœåŠ¡å™¨å’Œå®¢æˆ·åœ¨åŒä¸€å°ä¸»æœºä¸Šæ—¶å‘ç”Ÿ</p>

<pre><code class="language-c++">if (connect(fd, (struct sockaddr*)&amp;sa, sizeof(sa)) == -1)
if (errno != EINPROGRESS) {
    return -1;
    }
if(n == 0)
    goto done;
</code></pre>

<p>selectå‡½æ•°ï¼šIOå¤šè·¯å¤ç”¨æœºåˆ¶</p>

<ol>
<li>connectæœ¬èº«å¹¶ä¸å…·æœ‰è®¾ç½®è¶…æ—¶åŠŸèƒ½ï¼Œå¦‚æœæƒ³å¯¹å¥—æ¥å­—çš„IOæ“ä½œè®¾ç½®è¶…æ—¶ï¼Œå¯ä½¿ç”¨selectå‡½æ•°</li>
<li>å¯¹äºselectå’Œéé˜»å¡connectï¼Œæ³¨æ„ä¸¤ç‚¹ï¼šå½“è¿æ¥æˆåŠŸå»ºç«‹æ—¶ï¼Œæè¿°ç¬¦å˜æˆå¯å†™ï¼›å½“è¿æ¥å»ºç«‹é‡åˆ°é”™è¯¯æ—¶ï¼Œæè¿°ç¬¦å˜ä¸ºå³å¯è¯»ï¼Œä¹Ÿå¯å†™ï¼Œé‡åˆ°è¿™ç§æƒ…å†µï¼Œå¯è°ƒç”¨getsockoptå‡½æ•°</li>
</ol>

<p>å®ç°æ­¥éª¤ï¼š</p>

<ol>
<li>åˆ›å»ºsocketï¼Œå¹¶åˆ©ç”¨fcntlå°†å…¶è®¾ç½®ä¸ºéé˜»å¡</li>
<li>è°ƒç”¨connectå‡½æ•°ï¼Œå¦‚æœè¿”å›0ï¼Œåˆ™è¿æ¥å»ºç«‹(unlikely) ï¼›å¦‚æœè¿”å›-1ï¼Œæ£€æŸ¥errno ï¼Œå¦‚æœå€¼ä¸º EINPROGRESSï¼Œåˆ™è¿æ¥æ­£åœ¨å»ºç«‹</li>
<li>ä¸ºäº†æ§åˆ¶è¿æ¥å»ºç«‹æ—¶é—´ï¼Œå°†è¯¥socketæè¿°ç¬¦åŠ å…¥åˆ°selectçš„å¯å†™é›†åˆä¸­ï¼Œé‡‡ç”¨selectå‡½æ•°è®¾å®šè¶…æ—¶</li>
<li>å¦‚æœè§„å®šæ—¶é—´å†…æˆåŠŸå»ºç«‹ï¼Œåˆ™æè¿°ç¬¦å˜ä¸ºå¯å†™ï¼›å¦åˆ™ï¼Œé‡‡ç”¨getsockoptå‡½æ•°æ•è·é”™è¯¯ä¿¡æ¯</li>
<li>æ¢å¤å¥—æ¥å­—çš„æ–‡ä»¶çŠ¶æ€å¹¶è¿”å›</li>
</ol>

<h2 id="2-socketæ–­å¼€æ£€æµ‹-socketå…³é—­-socketç«¯å£å¤ç”¨">2. socketæ–­å¼€æ£€æµ‹ã€socketå…³é—­ã€socketç«¯å£å¤ç”¨</h2>

<p>socketæ–­å¼€æ£€æµ‹ï¼š</p>

<ol>
<li>TCPåè®®æœ‰ä¸€ä¸ªå®šæ—¶å™¨æ¥å†³å®šè¿æ¥æ˜¯å¦è¢«å¼‚å¸¸å…³é—­</li>
<li>ä½†æ˜¯è¯¥è¶…æ—¶æ—¶é—´å€¼ç¼ºçœçš„æƒ…å†µä¸‹ä¼šéå¸¸é•¿ï¼Œå¦‚æœä½ å¸Œæœ›å°½å¿«çš„æ£€æŸ¥å‡ºè¿™ç§çŠ¶æ€æ”¹è¿›æ€§èƒ½ï¼Œæœ€å¥½çš„æ–¹æ³•å°±æ˜¯åœ¨åº”ç”¨ç¨‹åºåè®®è®¾è®¡çš„æ—¶å€™å¼•å…¥keepaliveï¼ˆä¿æŒè¿æ¥ï¼‰æœºåˆ¶ã€‚</li>
</ol>

<p><a href="http://lexuslee.me/2017/09/06/close-socket/">socketå…³é—­</a>ï¼š</p>

<ol>
<li>Python Socket çš„ terminate() åªæ˜¯å‘é€ socket.SHUT_WR å’Œ socket.SHUT_RD æ¥å…³é—­é€šé“çš„è¯»å†™æƒé™è€Œå¹¶æ²¡æœ‰é‡Šæ”¾è¿æ¥å¥æŸ„ï¼›å¯¼è‡´äº†è¿æ¥å·²ç»æ— æ³•ä½¿ç”¨ï¼Œä½†ä»ç„¶å¤„äº ESTABLISHED çŠ¶æ€</li>
<li>å¦‚æœæ˜¯ DDoS æ”»å‡»çš„è¯ï¼Œå¯èƒ½ä¼šé˜»å¡ä½ socket.close() ï¼Œå¯¼è‡´åç»­è¿æ¥æœªå…³é—­ï¼Œå¤§é‡æµé‡è¿›å…¥æœåŠ¡å™¨</li>
<li>æ¯”è¾ƒå¥½çš„æ–¹å¼æ˜¯åœ¨ socket.close() ä¹‹å‰å…ˆè°ƒç”¨ socket.terminate() å…³é—­é€šé“çš„è¯»å†™æƒé™ï¼Œå†è°ƒç”¨ socket.close()</li>
</ol>

<p>socketç«¯å£å¤ç”¨ï¼š</p>

<ol>
<li>ç«¯å£è¿˜å¤„äºäºfin_wait_2çŠ¶æ€ï¼Œsolarisè¦4åˆ†é’Ÿæ‰èƒ½å…³é—­ï¼Œè‹¥ç­‰ä¸åŠæœ‰ä»¥ä¸‹2ç§è§£å†³æ–¹æ¡ˆ</li>
<li><code>s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)</code></li>
<li>ä¿®æ”¹ç³»ç»Ÿfin_wait,time_waitçš„æ—¶é—´è®¾ç½®</li>
</ol>

<h2 id="3-getsockopt-setsockopt">3. getsockopt/setsockopt</h2>

<p><code>int getsockopt(int s, int level, int optname, void *optval, socklen_t *optlen)</code></p>

<ol>
<li>å¯è·å–å½±å“å¥—æ¥å­—çš„é€‰é¡¹ï¼Œæ¯”å¦‚SOCKETçš„å‡ºé”™ä¿¡æ¯</li>
<li>å½“å‡½æ•°æˆåŠŸæ—¶è¿”å›0ã€‚å½“å‘ç”Ÿé”™è¯¯æ—¶ä¼šè¿”å›-1ï¼Œè€Œé”™è¯¯åŸå› ä¼šå­˜æ”¾åœ¨å¤–éƒ¨å˜é‡errnoä¸­</li>
<li>åè®®å±‚å‚æ•°æŒ‡æ˜äº†æˆ‘ä»¬å¸Œæœ›è®¿é—®ä¸€ä¸ªé€‰é¡¹æ‰€åœ¨çš„åè®®æ ˆã€‚é€šå¸¸æˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸‹é¢ä¸­çš„ä¸€ä¸ª

<ol>
<li>SOL_SOCKETæ¥è®¿é—®å¥—æ¥å£å±‚é€‰é¡¹</li>
<li>SOL_TCPæ¥è®¿é—®TCPå±‚é€‰é¡¹</li>
</ol></li>
<li>å‚æ•°optnameä¸ºä¸€ä¸ªæ•´æ•°å€¼ã€‚åœ¨è¿™é‡Œæ‰€ä½¿ç”¨çš„å€¼é¦–å…ˆæ˜¯ç”±æ‰€é€‰ç”¨çš„levelå‚æ•°æ¥ç¡®å®šçš„</li>
</ol>

<pre><code class="language-c++">err = 0;
errlen = sizeof(err);
if (getsockopt(fd, SOL_SOCKET, SO_ERROR, &amp;err, &amp;errlen) == -1) {
    sprintf(&quot;getsockopt(SO_ERROR): %s&quot;, strerror(errno)));
    close(fd);
    return ERR;
    }
if (err) {
    errno = err;
    close(fd);
    return ERR;
}

    åè®®å±‚       é€‰é¡¹åå­—
SOL_SOCKET   SO_REUSEADDR
SOL_SOCKET   SO_KKEPALIVE
SOL_SOCKET   SO_LINGER
SOL_SOCKET   SO_BROADCAST
SOL_SOCKET   SO_OOBINLINE
SOL_SOCKET   SO_SNDBUF
SOL_SOCKET   SO_RCVBUF
SOL_SOCKET   SO_TYPE
SOL_SOCKET   SO_ERROR
SOL_TCP       SO_NODELAY
</code></pre>

<p><code>int setsockopt(int s, int level, int optname, const void *optval, socklen_t optlen)</code></p>

<ol>
<li>é€‰é¡¹æ”¹å˜æ‰€è¦å½±å“çš„å¥—æ¥å­—s</li>
<li>é€‰é¡¹çš„å¥—æ¥å£å±‚æ¬¡level</li>
<li>è¦è®¾ç½®çš„é€‰é¡¹åoptname</li>
<li>æŒ‡å‘è¦ä¸ºæ–°é€‰é¡¹æ‰€è®¾ç½®çš„å€¼çš„æŒ‡é’ˆoptval</li>
<li>é€‰é¡¹å€¼é•¿åº¦optlen</li>
</ol>
</div>

    
    

    

        <h4 class="page-header">Related</h4>

         <div class="item">

    
    
    

    
    

    <h4><a href="/post/tcp%E6%96%AD%E5%8C%85%E7%B2%98%E5%8C%85%E9%97%AE%E9%A2%98/">TCPç²˜åŒ…é—®é¢˜ï¼šåˆ†åŒ…</a></h4>
    <h5>October 26, 2016</h5>
     <kbd class="item-tag">network</kbd> 

</div>
 

    

    

        <h4 class="page-header">Comments</h4>

        <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "Wiesen" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    

</main>

        <footer>

            <p class="copyright text-muted">&copy; All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a></p>

        </footer>
       
    </body>

</html>

